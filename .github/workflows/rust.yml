on: [push, pull_request]

name: CI

env:
  RUSTFLAGS: -D warnings
  RUSTDOCFLAGS: -D warnings

jobs:
  # ============================================================
  # ГЛАВНАЯ ПРОВЕРКА: Форматирование, линтинг, документация
  # ============================================================
  check:
    name: Format + Clippy + Doc
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libssl-dev \
            libgtk-3-dev

      - name: Cache cargo registry & target
        uses: Swatinem/rust-cache@v2

      # Форматирование кода
      - name: Check formatting
        run: cargo fmt --all -- --check

      # Clippy со всеми features
      - name: Clippy (all features)
        run: cargo clippy --all-targets --all-features -- -D warnings

      # Clippy без default features
      - name: Clippy (no default features)
        run: cargo clippy --no-default-features --lib -p egui-shadcn

      # Clippy для примеров
      - name: Clippy (examples feature)
        run: cargo clippy --features examples --all-targets -p egui-shadcn

      # Проверка документации
      - name: Generate docs
        run: cargo doc --lib --no-deps --all-features

      # Проверка приватной документации (для разработчиков)
      - name: Generate docs (private items)
        run: cargo doc --document-private-items --no-deps --all-features

      # Clippy в release-режиме (выявляет оптимизационные warning)
      - name: Clippy (release)
        run: cargo clippy --all-targets --all-features --release

  # ============================================================
  # WASM ПОДДЕРЖКА (если планируется веб-версия)
  # ============================================================
  check-wasm:
    name: Check WebAssembly
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry & target
        uses: Swatinem/rust-cache@v2

      # Проверка сборки под wasm32
      - name: Check wasm32 compilation
        run: |
          cargo check --lib -p egui-shadcn \
            --target wasm32-unknown-unknown \
            --no-default-features

      # Clippy для wasm32
      - name: Clippy wasm32
        run: |
          cargo clippy --lib -p egui-shadcn \
            --target wasm32-unknown-unknown \
            --no-default-features

  # ============================================================
  # WINDOWS ПРОВЕРКА
  # ============================================================
  windows:
    name: Check Windows
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry & target
        uses: Swatinem/rust-cache@v2

      # Clippy на нативной Windows
      - name: Clippy
        run: cargo clippy --all-targets --all-features

      # Проверка сборки примеров
      - name: Build examples
        run: cargo build --examples --features examples

  # ============================================================
  # ТЕСТЫ С GPU (macOS для доступа к реальному GPU)
  # ============================================================
  test:
    name: Run tests
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry & target
        uses: Swatinem/rust-cache@v2

      # Unit и integration тесты
      - name: Run tests
        run: cargo test --all-features

      # Doc-тесты из комментариев
      - name: Run doc tests
        run: cargo test --all-features --doc

  # ============================================================
  # АУДИТ ЗАВИСИМОСТЕЙ (опционально, но крайне полезно)
  # ============================================================
  cargo-deny:
    name: Dependency audit
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-pc-windows-msvc
          - x86_64-apple-darwin
          - wasm32-unknown-unknown
    steps:
      - uses: actions/checkout@v4

      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          rust-version: "1.90.0"
          log-level: error
          command: check
          arguments: --target ${{ matrix.target }}
